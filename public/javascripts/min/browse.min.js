var browse={toteBags:null,currPage:1,numPerPage:24,currSort:"latest",loadedAll:!1,totalBags:-1,currentlyBuilding:!1,getToteObj:function(e,t){var o=_.findWhere(browse.toteBags,{_id:e});if("undefined"==typeof o)$.getJSON("/data/tote/"+e,function(e){t(e,-1)});else{var r=_.indexOf(browse.toteBags,o);t(o,r)}},getToteObjFromIndex:function(e,t){browse.toteBags.length>=e?t([browse.toteBags[e]]):$.getJSON("/data/"+browse.currSort+"/"+e,function(e){t(e)})},sort:function(e){var t,o=(e.attr("data-attr"),e.attr("data-dir"),e.html());$("nav .sort .name").html(o),"Latest"===o?t="latest":"Oldest"===o?t="oldest":"Popular"===o?t="popular":"Most Views"===o&&(t="views"),t!==browse.currSort&&(browse.currSort=t,browse.currPage=1,window.history.pushState("html","Title","/"+t),$("head title").html(o+" | Totebag Maker | Huge inc."),browse.animateOut(function(){$(".browse-tote-wrap").empty(),browse.toteBags=null,browse.loadedAll=!1,e.hasClass("sort-option")&&($(".sort-option").removeClass("sel"),e.addClass("sel")),browse.loadBags(function(){browse.buildBagGrid()})}))},gridOrderHelper:function(e){var t=$(".tote-grid-element").width(),o=Math.round($(window).width()/t),r=e%(2*o);return o>r?e:e+(o-1-2*(r-o))},animateIn:function(e,t){e=e||0,browse.animateInHelper(e,t)},animateInHelper:function(e,t){var o=$(".tote-grid-element").length;return e>=o?void setTimeout(function(){$(".tote-grid-element.start").removeClass("start"),t&&void 0!==t&&t()},7*e):void setTimeout(function(){var o=browse.gridOrderHelper(e);0===$(".tote-grid-element").eq(o).length&&(o=e),$(".tote-grid-element").eq(o).removeClass("start"),browse.animateInHelper(e+1,t)},7*e)},animateOut:function(e){var t=$(".tote-grid-element").length;t>48?TweenLite.to(".browse-tote-wrap",.3,{alpha:0,ease:cssBezier,onComplete:function(){$(".browse-tote-wrap").empty(),$(".browse-tote-wrap").css("opacity","1"),e()}}):browse.animateOutHelper(t-1,e)},animateOutHelper:function(e,t){var o=$(".tote-grid-element").length;return 0>e?void setTimeout(function(){t&&void 0!==t&&t()},7*o):void setTimeout(function(){var o=browse.gridOrderHelper(e);$(".tote-grid-element").eq(o).addClass("start"),browse.animateOutHelper(e-1,t)},7*(o-e))},loadMoreBags:function(){browse.currentlyBuilding||browse.loadBags(function(){browse.buildBagGrid()})},loadBags:function(e){if(browse.currentlyBuilding=!0,null===browse.toteBags)$.getJSON("/data/"+browse.currSort+"/page/"+browse.currPage,function(t){browse.toteBags=t,"undefined"!=typeof e&&e()});else{if(browse.loadedAll)return;browse.currPage=browse.currPage+1,$.getJSON("/data/"+browse.currSort+"/page/"+browse.currPage,function(t){t.length<browse.numPerPage&&(browse.loadedAll=!0),browse.toteBags=browse.toteBags.concat(t),"undefined"!=typeof e&&e()})}},buildBagGrid:function(e,t){"undefined"==typeof e&&(e=!0);var o=(browse.currPage-1)*browse.numPerPage,r=o+browse.numPerPage,a=browse.toteBags.slice(o,r);_.each(a,function(r){r.swingTimer=null;var a={bags:[r]};$.get("/templates/_bag.html",function(i){var s=Handlebars.compile(i),n=s(a),l="<button class='heart-outer-wrap'><div class='heart-wrap'>",d=a.bags[0]._id;likes.indexOf(d)>-1&&(l="<button class='heart-outer-wrap favorited'><div class='heart-wrap'>"),l+="<div class='heart-circle'></div><div class='heart'>"+'<svg width="32px" height="29px" ><path d="M39.9504969,20.4285714 C37.4437267,20.4285714 34.8843478,21.6982109 33,24.6490918 C31.1163354,21.6982109 28.5562733,20.4292823 26.0495031,20.4285714 C21.5825466,20.4285714 17.2857143,24.4592857 17.2857143,30.186881 C17.2857143,36.2365068 22.5158385,40.5508639 26.4539752,43.8067143 C30.5410559,47.1905238 31.688882,47.9113605 33,49.2812347 C34.311118,47.9113605 35.4589441,47.1905238 39.5460248,43.8067143 C43.4841615,40.5508639 48.7142857,36.2365068 48.7142857,30.186881 C48.7142857,24.4592857 44.4167702,20.4285714 39.9504969,20.4285714"></path></svg></div></div></button>';var w=$("<div />",{"class":"tote-grid-element start "+a.bags[0].color,html:l+n});w.appendTo(".browse-page.content .browse-tote-wrap"),r===browse.toteBags[browse.toteBags.length-1]&&($(".browse-page.content .browse-tote-wrap .clearfix").remove(),$(".browse-page.content .browse-tote-wrap").append("<div class='clearfix'></div>"),site.refreshTypeOnTotes(),e?browse.animateIn(o,function(){browse.currentlyBuilding=!1}):($(".tote-grid-element.start").addClass("noAnimate").removeClass("start").removeClass("noAnimate"),browse.currentlyBuilding=!1),$("nav.hidden").removeClass("hidden"),"undefined"!=typeof t&&t())})})},view:function(e){function t(){$.get("/templates/_bag.html",function(t){for(var o=Handlebars.compile(t),r=0;r<s.length;r++){var a=o(s[r]);likes.indexOf(n[r])>-1&&1===r&&$(".view-controls .heart-outer-wrap").addClass("favorited");var i=$("<div />",{"class":"tote-grid-element view "+s[r].bags[0].color,"data-id":n[r],html:a}).appendTo(".view-carousel-wrap")}$(".view-carousel").addClass("on"),TweenLite.to(".view-carousel-wrap .tote-grid-element .actual-tote, .view-carousel-wrap .tote-grid-element .tote-shadow",0,{rotation:"0deg"}),TweenLite.to(".view-carousel-wrap .tote-grid-element .tote-shadow",.5,{alpha:1,ease:cssBezier}),$(".view-carousel-wrap .tote-grid-element.swinging").removeClass("swinging"),site.refreshTypeOnTotes();var i=$(".view-carousel-wrap .tote-grid-element").eq(1),l=i.find(".tote-wrap").height(),d=i.height(),w=(d-$(window).height())/2;l>$(window).height()&&(w=l),$(".view-carousel-wrap").scrollTop(w),window.history.pushState("html","Title","/"+browse.currSort+"/tote/"+e),bagObject.upViewCount(e),$("head title").html("View Tote | Totebag Maker | Huge inc."),$("body").addClass("lock-scroll"),$(".view-carousel").attr("data-display",e)})}var o,r,a,i="/data/"+browse.currSort+"/tote/"+e,s=[],n=[];$.getJSON(i,function(e){o={bags:[e]},$(".view-controls .heart-outer-wrap").attr("class","heart-outer-wrap "+e.color);var i=e.index,l=e.prevIndex,d=e.nextIndex;browse.totalBags=e.totalBags,$(".view-carousel").attr("data-index",i),browse.getToteObjFromIndex(l,function(e){a={bags:e},browse.getToteObjFromIndex(d,function(e){r={bags:e},s=[a,o,r],n=[a.bags[0]._id,o.bags[0]._id,r.bags[0]._id],t()})})})},viewZoomIn:function(e){var t=e.offset().left,o=e.offset().top-$(window).scrollTop(),r=e.outerHeight(),a=e.outerWidth(),i=$("<div />",{id:"zoomAnimation","class":e.attr("class")+"",html:e.html()});i.find(".heart-outer-wrap").remove(),i.height(r),i.width(a),$(".zoomAnimationWrapper").append(i),TweenLite.to(i,0,{x:t,y:o}),i.removeClass("swinging"),TweenLite.to(i.find(".actual-tote"),.3,{rotation:"0deg"}),TweenLite.to(i.find(".tote-shadow"),.3,{rotation:"0deg"}),site.refreshTypeOnTotes(),$("body").addClass("lock-scroll");var s=$(window).width(),n=$(window).height(),l=Math.round(s/a);TweenLite.to(i,.5,{x:(l-1)/2*a,y:0,height:1.5*n/l,scale:l,ease:cssBezier,onComplete:function(){TweenLite.to(i,0,{x:0,y:0,width:"100%",height:1.5*n,scale:1}),site.refreshTypeOnTotes();var t=i.find(".tote-wrap").height(),o=i.height(),r=($(window).height()-t)/2;t>$(window).height()&&(r=o),$(".zoomAnimationWrapper").animate({scrollTop:r},r/2,function(){var t=e.index(),o=browse.toteBags[t]._id;browse.view(o),setTimeout(function(){$("#zoomAnimation").remove()},1e3)})}})},viewZoomOut:function(){function e(e){TweenLite.to(e,.5,{x:t-1*(i-1)/2*r,y:o-$(window).scrollTop(),scale:a,ease:cssBezier,height:r/a,onComplete:function(){e.remove(),$(".view-controls button.disabled").removeClass("disabled"),window.history.pushState("html","Title","/"+browse.currSort),$("head title").html("Totebag Maker | Huge inc.")}})}var t,o,r,a,i,s=$(".view-carousel").attr("data-display");browse.getToteObj(s,function(s,n){if(n>-1){var l=$(".browse-tote-wrap .tote-grid-element").eq(n),d=$("<div />",{id:"zoomAnimation","class":l.attr("class")+"",html:l.html()});d.find(".heart-outer-wrap").remove(),r=l.outerWidth();var w=$(window).width(),u=$(window).height();a=r/w,i=Math.round(1/a),t=l.offset().left,o=l.offset().top,TweenLite.to(d,0,{x:0,y:0,width:"100%",scale:1,height:1.5*u}),$(".zoomAnimationWrapper").append(d),site.refreshTypeOnTotes();var g=$(".view-carousel-wrap").scrollTop();$(".zoomAnimationWrapper").scrollTop(g),$(".view-carousel-wrap").empty(),$(".view-carousel").removeClass("on"),$("body").removeClass("lock-scroll"),o>$(window).scrollTop()+$(window).outerHeight()-r||o<$(window).scrollTop()?$("body","html").animate({scrollTop:o-r},0,function(){e(d)}):e(d)}else window.location.href="/"})},swingOnce:function(e){var t=e.find(".actual-tote"),o=e.find(".tote-shadow");TweenLite.to(o,.5,{rotation:"-4deg",scaleX:.9,ease:gridBagBezier}),TweenLite.to(t,.5,{rotation:"5deg",ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"0deg",scaleX:1,ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"4deg",scaleX:.9,ease:gridBagBezier})}}),TweenLite.to(t,1,{rotation:"-5deg",ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"0.1deg",scaleX:1,ease:gridBagBezier,onComplete:function(){}}),TweenLite.to(t,.5,{rotation:"-0.1deg",ease:gridBagBezier})}})}})},swing:function(e){var t;t="undefined"==typeof e.attr("data-id")?e.index():parseInt(e.attr("data-id")),e.hasClass("swinging")?clearTimeout(browse.toteBags[t].stopTimer):(browse.swingOnce(e),e.addClass("swinging"),browse.toteBags[t].swingTimer=setInterval(function(){browse.swingOnce(e)},1870))},stopSwing:function(e){var t;t="undefined"==typeof e.attr("data-id")?e.index():parseInt(e.attr("data-id")),browse.toteBags[t].stopTimer=setTimeout(function(){e.removeClass("swinging"),clearInterval(browse.toteBags[t].swingTimer)},500)},syncSortView:function(){browse.currSort=$("#sort").html(),$("#sort").remove(),""===$("#viewId").html()&&-1===window.location.href.indexOf(browse.currSort)&&window.history.pushState("html","Title","/"+browse.currSort);var e;e="latest"===browse.currSort?"Latest":"oldest"===browse.currSort?"Oldest":"popular"===browse.currSort?"Popular":"views"===browse.currSort?"Most Views":"Latest",$("nav .sort .selected-sort .name").html(e),$(".sort-option[data-name='"+browse.currSort+"']").addClass("sel")}};$(document).ready(function(){likes.fetchUserLikes(),browse.syncSortView(),browse.loadBags(function(){var e=$("#viewId").html();$("#viewId").remove(),""===e?browse.buildBagGrid():(browse.view(e),setTimeout(function(){browse.buildBagGrid(!1)},500))}),$(".sort").hover(function(){$(".sort").toggleClass("on-state")}),$(".sort ul li, .sort .sort-option").hammer().on("tap",function(){browse.sort($(this))}),$(document).hammer().on("tap, release","button.heart-outer-wrap",function(e){e.preventDefault(),e.stopPropagation();var t,o;if($(this).parents(".view-controls").length>0)o=$(this).parents(".view-carousel").attr("data-display");else{var r=$(this).parents(".tote-grid-element");t=r.index();var a=browse.toteBags[t];o=a._id}$(this).hasClass("favorited")?(likes.unfavorite($(this)),likes.unlikeBag(o),$(this).parents(".view-controls").length>0&&likes.unfavorite($(".browse-tote-wrap .tote-grid-element").eq(t).find(".heart-outer-wrap"))):(likes.favorite($(this)),likes.likeBag(o),$(this).parents(".view-controls").length>0&&likes.favorite($(".browse-tote-wrap .tote-grid-element").eq(t).find(".heart-outer-wrap")))}),$(document).on("mouseenter",".browse-tote-wrap .tote-grid-element",function(){browse.swing($(this))}),$(document).on("mouseleave",".browse-tote-wrap .tote-grid-element",function(){browse.stopSwing($(this))}),$(".tote-grid-element").hover(function(){browse.swing($(this))},function(){browse.stopSwing($(this))}),$(document).hammer().on("release",".browse-tote-wrap .tote-grid-element",function(e){e.preventDefault(),e.stopPropagation(),Math.abs(e.gesture.deltaX)>10||Math.abs(e.gesture.deltaY)>10||browse.viewZoomIn($(this))})});