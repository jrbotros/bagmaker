var browse={toteBags:null,currPage:1,numPerPage:24,currSort:"newest",loadedAll:!1,currentlyBuilding:!1,getToteObj:function(e,t){var o=_.findWhere(browse.toteBags,{_id:e});if("undefined"==typeof o)$.getJSON("/data/tote/"+e,function(e){t(e,-1)});else{var r=_.indexOf(browse.toteBags,o);t(o,r)}},sort:function(e){var t,o=(e.attr("data-attr"),e.attr("data-dir"),e.html());$("nav .sort .name").html(o),"Newest"===o?t="newest":"Oldest"===o?t="oldest":"Popular"===o?t="popular":"Most Views"===o&&(t="views"),t!==browse.currSort&&(browse.currSort=t,browse.currPage=1,window.history.pushState("html","Title","/"+t),$("head title").html(o+" | Totebag Maker | Huge inc."),browse.animateOut(function(){$(".browse-tote-wrap").empty(),browse.toteBags=null,browse.loadedAll=!1,browse.loadBags(function(){browse.buildBagGrid()})}))},gridOrderHelper:function(e){var t=$(".tote-grid-element").width(),o=Math.round($(window).width()/t),r=e%(2*o);return o>r?e:e+(o-1-2*(r-o))},animateIn:function(e,t){e=e||0,browse.animateInHelper(e,t)},animateInHelper:function(e,t){var o=$(".tote-grid-element").length;return e>=o?void setTimeout(function(){$(".tote-grid-element.start").removeClass("start"),t&&void 0!==t&&t()},20*e):void setTimeout(function(){var o=browse.gridOrderHelper(e);0===$(".tote-grid-element").eq(o).length&&(o=e),$(".tote-grid-element").eq(o).removeClass("start"),browse.animateInHelper(e+1,t)},20*e)},animateOut:function(e){var t=$(".tote-grid-element").length;browse.animateOutHelper(t-1,e)},animateOutHelper:function(e,t){var o=$(".tote-grid-element").length;return 0>e?void setTimeout(function(){t&&void 0!==t&&t()},7*o):void setTimeout(function(){var o=browse.gridOrderHelper(e);$(".tote-grid-element").eq(o).addClass("start"),browse.animateOutHelper(e-1,t)},7*(o-e))},loadMoreBags:function(){browse.currentlyBuilding||browse.loadBags(function(){browse.buildBagGrid()})},loadBags:function(e){if(browse.currentlyBuilding=!0,null===browse.toteBags)$.getJSON("/data/"+browse.currSort+"/"+browse.currPage,function(t){browse.toteBags=t,"undefined"!=typeof e&&e()});else{if(browse.loadedAll)return;browse.currPage=browse.currPage+1,$.getJSON("/data/"+browse.currSort+"/"+browse.currPage,function(t){t.length<browse.numPerPage&&(browse.loadedAll=!0),browse.toteBags=browse.toteBags.concat(t),"undefined"!=typeof e&&e()})}},buildBagGrid:function(e,t){"undefined"==typeof e&&(e=!0);var o=(browse.currPage-1)*browse.numPerPage,r=o+browse.numPerPage,i=browse.toteBags.slice(o,r);_.each(i,function(r){r.swingTimer=null;var i={bags:[r]};$.get("/templates/_bag.html",function(a){var n=Handlebars.compile(a),s=n(i),l="<button class='heart-outer-wrap'><div class='heart-wrap'>",d=i.bags[0]._id;likes.indexOf(d)>-1&&(l="<button class='heart-outer-wrap favorited'><div class='heart-wrap'>"),l+="<div class='heart-circle'></div><div class='heart'><div class='inner-heart'></div></div></div></button>";var w=$("<div />",{"class":"tote-grid-element start "+i.bags[0].color,html:l+s});w.appendTo(".browse-page.content .browse-tote-wrap"),r===browse.toteBags[browse.toteBags.length-1]&&($(".browse-page.content .browse-tote-wrap .clearfix").remove(),$(".browse-page.content .browse-tote-wrap").append("<div class='clearfix'></div>"),site.refreshTypeOnTotes(),e?browse.animateIn(o,function(){browse.currentlyBuilding=!1}):($(".tote-grid-element.start").addClass("noAnimate").removeClass("start").removeClass("noAnimate"),browse.currentlyBuilding=!1),$("nav.hidden").removeClass("hidden"),"undefined"!=typeof t&&t())})})},view:function(e){function t(){$.get("/templates/_bag.html",function(t){for(var o=Handlebars.compile(t),r=0;r<a.length;r++){var i=o(a[r]);likes.indexOf(n[r])>-1&&1===r&&$(".view-controls .heart-outer-wrap").addClass("favorited");var s=$("<div />",{"class":"tote-grid-element view "+a[r].bags[0].color,"data-id":n[r],html:i}).appendTo(".view-carousel-wrap")}$(".view-carousel").addClass("on"),TweenLite.to(".view-carousel-wrap .tote-grid-element .actual-tote, .view-carousel-wrap .tote-grid-element .tote-shadow",0,{rotation:"0deg"}),TweenLite.to(".view-carousel-wrap .tote-grid-element .tote-shadow",.5,{alpha:1,ease:cssBezier}),$(".view-carousel-wrap .tote-grid-element.swinging").removeClass("swinging"),site.refreshTypeOnTotes();var s=$(".view-carousel-wrap .tote-grid-element").eq(1),l=s.find(".tote-wrap").height(),d=s.height(),w=(d-$(window).height())/2;l>$(window).height()&&(w=l),$(".view-carousel-wrap").scrollTop(w),window.history.pushState("html","Title","/totes/"+e),bagObject.upViewCount(e),$("head title").html("View Tote | Totebag Maker | Huge inc."),$("body").addClass("lock-scroll"),$(".view-carousel").attr("data-display",e)})}var o="/data/"+browse.currSort+"/"+e+"/prev",r="/data/"+browse.currSort+"/"+e+"/next",i="/data/tote/"+e,a=[],n=[];$.getJSON(o,function(o){n.push(o[0]._id),a.push({bags:o}),$.getJSON(i,function(o){n.push(e),a.push({bags:[o]}),$(".view-controls .heart-outer-wrap").attr("class","heart-outer-wrap "+o.color),$.getJSON(r,function(e){n.push(e[0]._id),a.push({bags:e}),t()})})})},viewZoomIn:function(e){var t=e.offset().left,o=e.offset().top-$(window).scrollTop(),r=e.outerHeight(),i=e.outerWidth(),a=$("<div />",{id:"zoomAnimation","class":e.attr("class")+"",html:e.html()});a.find(".heart-outer-wrap").remove(),a.height(r),a.width(i),$(".zoomAnimationWrapper").append(a),TweenLite.to(a,0,{x:t,y:o}),a.removeClass("swinging"),TweenLite.to(a.find(".actual-tote"),.3,{rotation:"0deg"}),TweenLite.to(a.find(".tote-shadow"),.3,{rotation:"0deg"}),site.refreshTypeOnTotes(),$("body").addClass("lock-scroll");var n=$(window).width(),s=$(window).height(),l=Math.round(n/i);TweenLite.to(a,.5,{x:(l-1)/2*i,y:0,height:1.5*s/l,scale:l,ease:cssBezier,onComplete:function(){TweenLite.to(a,0,{x:0,y:0,width:"100%",height:1.5*s,scale:1}),site.refreshTypeOnTotes();var t=a.find(".tote-wrap").height(),o=a.height(),r=($(window).height()-t)/2;t>$(window).height()&&(r=o),$(".zoomAnimationWrapper").animate({scrollTop:r},r/2,function(){var t=e.index(),o=browse.toteBags[t]._id;browse.view(o),setTimeout(function(){$("#zoomAnimation").remove()},1e3)})}})},viewZoomOut:function(){function e(e){TweenLite.to(e,.5,{x:t-1*(a-1)/2*r,y:o-$(window).scrollTop(),scale:i,ease:cssBezier,height:r/i,onComplete:function(){e.remove(),$(".view-controls button.disabled").removeClass("disabled"),window.history.pushState("html","Title","/"+browse.currSort),$("head title").html("Totebag Maker | Huge inc.")}})}var t,o,r,i,a,n=$(".view-carousel").attr("data-display");browse.getToteObj(n,function(n,s){if(s>-1){var l=$(".browse-tote-wrap .tote-grid-element").eq(s),d=$("<div />",{id:"zoomAnimation","class":l.attr("class")+"",html:l.html()});d.find(".heart-outer-wrap").remove(),r=l.outerWidth();var w=$(window).width(),u=$(window).height();i=r/w,a=Math.round(1/i),t=l.offset().left,o=l.offset().top,TweenLite.to(d,0,{x:0,y:0,width:"100%",scale:1,height:1.5*u}),$(".zoomAnimationWrapper").append(d),site.refreshTypeOnTotes();var c=$(".view-carousel-wrap").scrollTop();$(".zoomAnimationWrapper").scrollTop(c),$(".view-carousel-wrap").empty(),$(".view-carousel").removeClass("on"),$("body").removeClass("lock-scroll"),o>$(window).scrollTop()+$(window).outerHeight()-r||o<$(window).scrollTop()?$("body","html").animate({scrollTop:o-r},0,function(){e(d)}):e(d)}else window.location.href="/"})},swingOnce:function(e){var t=e.find(".actual-tote"),o=e.find(".tote-shadow");TweenLite.to(o,.5,{rotation:"-4deg",scaleX:.9,ease:gridBagBezier}),TweenLite.to(t,.5,{rotation:"5deg",ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"0deg",scaleX:1,ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"4deg",scaleX:.9,ease:gridBagBezier})}}),TweenLite.to(t,1,{rotation:"-5deg",ease:gridBagBezier,onComplete:function(){TweenLite.to(o,.5,{rotation:"0deg",scaleX:1,ease:gridBagBezier,onComplete:function(){}}),TweenLite.to(t,.5,{rotation:"0deg",ease:gridBagBezier})}})}})},swing:function(e){var t;t="undefined"==typeof e.attr("data-id")?e.index():parseInt(e.attr("data-id")),e.hasClass("swinging")?clearTimeout(browse.toteBags[t].stopTimer):(browse.swingOnce(e),e.addClass("swinging"),browse.toteBags[t].swingTimer=setInterval(function(){browse.swingOnce(e)},1870))},stopSwing:function(e){var t;t="undefined"==typeof e.attr("data-id")?e.index():parseInt(e.attr("data-id")),browse.toteBags[t].stopTimer=setTimeout(function(){e.removeClass("swinging"),clearInterval(browse.toteBags[t].swingTimer)},500)},syncSortView:function(){browse.currSort=$("#sort").html(),$("#sort").remove(),""===$("#viewId").html()&&-1===window.location.href.indexOf(browse.currSort)&&window.history.pushState("html","Title","/"+browse.currSort);var e;e="newest"===browse.currSort?"Newest":"oldest"===browse.currSort?"Oldest":"popular"===browse.currSort?"Popular":"views"===browse.currSort?"Most Views":"Newest",$("nav .sort .selected-sort .name").html(e)}};$(document).ready(function(){likes.fetchUserLikes(),browse.syncSortView(),browse.loadBags(function(){var e=$("#viewId").html();$("#viewId").remove(),""===e?browse.buildBagGrid():(browse.view(e),setTimeout(function(){browse.buildBagGrid(!1)},500))}),$(".sort").hover(function(){$(".sort").toggleClass("on-state")}),$(".sort ul li").hammer().on("tap",function(){browse.sort($(this))}),$(document).hammer().on("tap, release","button.heart-outer-wrap",function(e){e.preventDefault(),e.stopPropagation(),console.log("heart");var t,o;if($(this).parents(".view-controls").length>0)o=$(this).parents(".view-carousel").attr("data-display");else{var r=$(this).parents(".tote-grid-element");t=r.index();var i=browse.toteBags[t];o=i._id}$(this).hasClass("favorited")?(likes.unfavorite($(this)),likes.unlikeBag(o),$(this).parents(".view-controls").length>0&&likes.unfavorite($(".browse-tote-wrap .tote-grid-element").eq(t).find(".heart-outer-wrap"))):(likes.favorite($(this)),likes.likeBag(o),$(this).parents(".view-controls").length>0&&likes.favorite($(".browse-tote-wrap .tote-grid-element").eq(t).find(".heart-outer-wrap")))}),$(document).on("mouseenter",".browse-tote-wrap .tote-grid-element",function(){browse.swing($(this))}),$(document).on("mouseleave",".browse-tote-wrap .tote-grid-element",function(){browse.stopSwing($(this))}),$(".tote-grid-element").hover(function(){browse.swing($(this))},function(){browse.stopSwing($(this))}),$(document).hammer().on("release",".browse-tote-wrap .tote-grid-element",function(e){e.preventDefault(),e.stopPropagation(),console.log("zoom"),browse.viewZoomIn($(this))})});